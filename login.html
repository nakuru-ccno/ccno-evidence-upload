<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nakuru County CCNO PC Evidence Upload</title>

  <link rel="icon" type="image/x-icon" href="images/favicon.ico">

  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; margin: 0; padding: 0; color: #333; }
    header { display: flex; align-items: center; gap: 12px; background: #0277bd; padding: 12px 18px; color: #fff; font-weight: 700; font-size: 1.05rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    header img { height: 52px; width: 52px; object-fit: contain; background: #fff; border-radius: 50%; padding: 4px; }
    .container { max-width: 480px; background: #fff; margin: 48px auto; padding: 32px 36px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-top: 6px solid #2e7d32; }
    h2 { text-align: center; font-weight: 800; color: #b71c1c; margin: 0 0 20px; }
    label { display: block; margin-top: 16px; font-weight: 700; color: #2e7d32; }
    input, select { width: 100%; padding: 12px 14px; margin-top: 8px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 1rem; background: #fff; box-sizing: border-box; }
    input:focus, select:focus { outline: none; border-color: #0277bd; box-shadow: 0 0 0 3px rgba(2,119,189,0.15); }
    button { margin-top: 22px; width: 100%; padding: 14px 16px; font-size: 1.05rem; background: #b71c1c; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 800; transition: background 0.2s; }
    button:hover { background: #d32f2f; }
    .toggle { text-align: center; margin-top: 16px; font-size: 0.9rem; color: #0277bd; font-weight: 600; cursor: pointer; }
    .form { display: none; }
    .form.active { display: block; }
    .message { text-align: center; margin-top: 18px; font-size: 0.95rem; }
    .success { background: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; padding: 12px; border-radius: 8px; }
    .error { background: #ffebee; color: #b71c1c; border: 1px solid #ef9a9a; padding: 12px; border-radius: 8px; }
    .loading { display: none; text-align: center; margin-top: 14px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2e7d32; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
<header>
  <img src="images/LOGO.png" alt="Nakuru County Logo" />
  Nakuru County CCNO Performance Contract Evidence Upload
</header>

<div class="container">
  <h2 id="formTitle">Login</h2>

  <!-- Login Form -->
  <div id="loginForm" class="form active">
    <label>Email</label>
    <input type="email" id="loginEmail" placeholder="Enter your email" required>
    <label>Password</label>
    <input type="password" id="loginPassword" placeholder="Enter your password" required>
    <button onclick="login()">Login</button>
    <div class="loading" id="loginLoading"><div class="spinner"></div></div>
    <div class="toggle" onclick="toggleForm('register')">Don't have an account? Register</div>
    <div class="toggle" onclick="openForgot()">Forgot Password?</div>
  </div>

  <!-- Register Form -->
  <div id="registerForm" class="form">
    <label>Full Name</label>
    <input type="text" id="regFullName" placeholder="Enter your full name" required>

    <label>Email</label>
    <input type="email" id="regEmail" placeholder="Enter your email" required>

    <label>Password</label>
    <input type="password" id="regPassword" placeholder="Enter your password" required>

    <label>Role / Position</label>
    <input type="text" id="regRole" placeholder="e.g., Health Officer, Data Manager" required>

   <select id="subCounty">
    <option value="">Select Sub County</option>
    <option value="Nakuru West Sub County">Nakuru West Sub County</option>
    <option value="Nakuru East Sub County">Nakuru East Sub County</option>
    <option value="Nakuru North Sub County">Nakuru North Sub County</option>
    <option value="Naivasha Sub County">Naivasha Sub County</option>
    <option value="Rongai Sub County">Rongai Sub County</option>
    <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
    <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
    <option value="Subukia Sub County">Subukia Sub County</option>
    <option value="Molo Sub County">Molo Sub County</option>
    <option value="Njoro Sub County">Njoro Sub County</option>
    <option value="Gilgil Sub County">Gilgil Sub County</option>
  </select>

    <button onclick="register()">Create Account</button>
    <div class="loading" id="registerLoading"><div class="spinner"></div></div>
    <div class="toggle" onclick="toggleForm('login')">Already have an account? Login</div>
  </div>

  <div id="message" class="message"></div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbz_20z65La3SBT3xv7SdsCLeGY60L0_Hck7KOCse8kRCVc7Hr14g4_xHraZaNFKN2qp/exec";

  function toggleForm(type) {
    document.getElementById('loginForm').classList.toggle('active', type === 'login');
    document.getElementById('registerForm').classList.toggle('active', type === 'register');
    document.getElementById("formTitle").innerText = type === 'login' ? "Login" : "Create Account";
    document.getElementById('message').innerHTML = "";
  }

  async function login() {
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value.trim();
    const loading = document.getElementById('loginLoading');
    loading.style.display = "block";
    document.getElementById('message').innerHTML = "";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "login", email, password }),
      });
      const data = await res.json();
      loading.style.display = "none";

      if (data.success) {
        localStorage.setItem("ccno_user", JSON.stringify({
          fullName: data.fullName,
          email: data.email,
          role: data.role,
          subCounty: data.subCounty,
          status: data.status,
          token: data.token
        }));
        // Redirect to index.html or dashboard
        window.location.href = "index.html";
      } else {
        document.getElementById('message').innerHTML = `<div class="error">${data.message}</div>`;
      }
    } catch (err) {
      loading.style.display = "none";
      document.getElementById('message').innerHTML = `<div class="error">Error connecting to server.</div>`;
    }
  }

  async function register() {
    const fullName = document.getElementById('regFullName').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value.trim();
    const role = document.getElementById('regRole').value.trim();
    const subCounty = document.getElementById('regSubCounty').value;
    const loading = document.getElementById('registerLoading');
    loading.style.display = "block";
    document.getElementById('message').innerHTML = "";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({
          action: "register",
          fullName,
          email,
          password,
          role,
          subCounty
        }),
      });
      const data = await res.json();
      loading.style.display = "none";

      if (data.success) {
        document.getElementById('message').innerHTML = `<div class="success">âœ… Account created! Wait for admin approval.</div>`;
        toggleForm('login');
      } else {
        document.getElementById('message').innerHTML = `<div class="error">${data.message}</div>`;
      }
    } catch (err) {
      loading.style.display = "none";
      document.getElementById('message').innerHTML = `<div class="error">Error connecting to server.</div>`;
    }
  }

  // Forgot Password Modal
  function openForgot() { document.getElementById("forgotModal").style.display = "block"; }
  function closeForgot() { document.getElementById("forgotModal").style.display = "none"; }
  async function sendReset() {
    const email = document.getElementById("forgotEmail").value.trim();
    const loading = document.getElementById("forgotLoading");
    loading.style.display = "block";

    try {
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "forgotPassword", email }),
      });
      const data = await res.json();
      loading.style.display = "none";
      document.getElementById("message").innerHTML = data.success
        ? `<div class="success">ðŸ“§ Reset instructions sent to your email.</div>`
        : `<div class="error">${data.message}</div>`;
      closeForgot();
    } catch (err) {
      loading.style.display = "none";
      document.getElementById("message").innerHTML = `<div class="error">Error connecting to server.</div>`;
      closeForgot();
    }
  }
</script>

<!-- Forgot Password Modal -->
<div id="forgotModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6);">
  <div style="background:#fff; max-width:400px; margin:80px auto; padding:24px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.2); text-align:center;">
    <h3>Reset Password</h3>
    <p>Enter your email to receive reset instructions.</p>
    <input type="email" id="forgotEmail" placeholder="Enter your email" style="width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:8px;">
    <button onclick="sendReset()">Send Reset Link</button>
    <div class="loading" id="forgotLoading"><div class="spinner"></div></div>
    <div class="toggle" onclick="closeForgot()" style="margin-top:12px;">Cancel</div>
  </div>
</div>

</body>
</html>
