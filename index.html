<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCNO Evidence Upload Portal</title>
<link rel="icon" type="image/x-icon" href="images/favicon.ico">
<link rel="stylesheet" href="style.css">
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <img src="images/LOGO.png" alt="Nakuru County Logo" class="logo" />
  <div class="header-texts">
    <h1>Nakuru County CCNO PC Evidence Upload System</h1>
  </div>
</header>

<div class="container">
  <!-- Friendlier intro line instead of duplicate heading -->
  <p class="form-intro">
    üìÇ Please fill in the details below to upload PC Evidence for FY 2025/2026
  </p>

  <label for="officerEmail">Officer Email:</label>
  <input list="officerEmails" id="officerEmail" placeholder="Enter officer's email" required />
  <datalist id="officerEmails"></datalist>
  <div class="email-note">üì© You will receive an email confirmation once your files are received.</div>

  <label for="evidenceName">Evidence Name:</label>
  <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods" />

  <label for="category">Evidence Category:</label>
  <select id="category">
    <option value="">Select Evidence Category</option>
  </select>

  <label for="indicator">Indicator:</label>
  <select id="indicator">
    <option value="">Select Indicator</option>
  </select>

  <label for="subCounty">Sub County:</label>
  <select id="subCounty">
    <option value="">Select Sub County</option>
    <option value="Nakuru West Sub County">Nakuru West Sub County</option>
    <option value="Nakuru East Sub County">Nakuru East Sub County</option>
    <option value="Nakuru North Sub County">Nakuru North Sub County</option>
    <option value="Naivasha Sub County">Naivasha Sub County</option>
    <option value="Rongai Sub County">Rongai Sub County</option>
    <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
    <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
    <option value="Subukia Sub County">Subukia Sub County</option>
    <option value="Molo Sub County">Molo Sub County</option>
    <option value="Njoro Sub County">Njoro Sub County</option>
    <option value="Gilgil Sub County">Gilgil Sub County</option>
  </select>

  <label for="files">Choose PDF file(s):</label>
  <input type="file" id="files" accept="application/pdf" multiple />

  <div class="spinner" id="spinner"></div>
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="upload-progress-text" id="uploadText"></div>
  <div class="success" id="success"></div>
  <div class="error" id="error"></div>

  <button id="uploadBtn">Upload Evidence</button>
</div>

<!-- FOOTER -->
<footer class="site-footer">
  <p>¬© 2025 Nakuru County Chief Nursing Officer. All Rights Reserved.</p>
</footer>

<script>
const PROXY_URL = "https://nccnoproxyy.onrender.com/upload-evidence";

const officerEmailInput = document.getElementById("officerEmail");
const evidenceNameInput = document.getElementById("evidenceName");
const categorySelect = document.getElementById("category");
const indicatorSelect = document.getElementById("indicator");
const subCountySelect = document.getElementById("subCounty");
const filesInput = document.getElementById("files");
const spinner = document.getElementById("spinner");
const successMsg = document.getElementById("success");
const errorMsg = document.getElementById("error");
const uploadBtn = document.getElementById("uploadBtn");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const uploadText = document.getElementById("uploadText");

// Load categories + indicators from JSON
fetch("indicators.json")
  .then(res => res.json())
  .then(data => {
    Object.keys(data).forEach(category => {
      const opt = document.createElement("option");
      opt.value = category;
      opt.textContent = category;
      categorySelect.appendChild(opt);
    });

    categorySelect.addEventListener("change", () => {
      const selected = categorySelect.value;
      indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
      if (data[selected]) {
        data[selected].forEach(ind => {
          const opt = document.createElement("option");
          opt.value = ind;
          opt.textContent = ind;
          indicatorSelect.appendChild(opt);
        });
      }
    });
  })
  .catch(err => console.error("Error loading indicators.json:", err));

// LocalStorage for previous emails
function saveOfficerEmail(email) {
  if (!email) return;
  let emails = JSON.parse(localStorage.getItem("officerEmails") || "[]");
  if (!emails.includes(email)) {
    emails.push(email);
    localStorage.setItem("officerEmails", JSON.stringify(emails));
  }
}

officerEmailInput.addEventListener("focus", () => {
  const datalist = document.getElementById("officerEmails");
  datalist.innerHTML = "";
  let emails = JSON.parse(localStorage.getItem("officerEmails") || "[]");
  emails.forEach(email => {
    const option = document.createElement("option");
    option.value = email;
    datalist.appendChild(option);
  });
});

// Helper functions
function showError(msg) {
  errorMsg.textContent = msg;
  errorMsg.style.display = msg ? "block" : "none";
  errorMsg.classList.add("show");
  successMsg.style.display = "none";
  successMsg.classList.remove("show");
}

function showSuccess(msg) {
  successMsg.textContent = msg;
  successMsg.style.display = "block";
  successMsg.classList.add("show");
  errorMsg.style.display = "none";
  errorMsg.classList.remove("show");
}

function resetForm() {
  evidenceNameInput.value = "";
  categorySelect.value = "";
  indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
  subCountySelect.value = "";
  filesInput.value = "";
  progressBar.style.width = "0%";
  progressContainer.style.display = "none";
  uploadText.style.display = "none";
}

// Remove red border instantly when user types/changes value
[officerEmailInput, evidenceNameInput, categorySelect, indicatorSelect, subCountySelect, filesInput].forEach(el => {
  el.addEventListener("input", () => el.style.border = "");
  el.addEventListener("change", () => el.style.border = "");
});

// Upload logic
uploadBtn.addEventListener("click", () => {
  const officerEmail = officerEmailInput.value.trim();
  const evidenceName = evidenceNameInput.value.trim();
  const category = categorySelect.value;
  const indicator = indicatorSelect.value;
  const subCounty = subCountySelect.value;
  const files = filesInput.files;

  let missing = [];

  // Reset borders
  [officerEmailInput, evidenceNameInput, categorySelect, indicatorSelect, subCountySelect, filesInput].forEach(el => {
    el.style.border = "";
  });

  if (!officerEmail) { missing.push("Officer Email"); officerEmailInput.style.border = "2px solid red"; }
  if (!evidenceName) { missing.push("Evidence Name"); evidenceNameInput.style.border = "2px solid red"; }
  if (!category) { missing.push("Category"); categorySelect.style.border = "2px solid red"; }
  if (!indicator) { missing.push("Indicator"); indicatorSelect.style.border = "2px solid red"; }
  if (!subCounty) { missing.push("Sub-County"); subCountySelect.style.border = "2px solid red"; }
  if (!files.length) { missing.push("PDF File(s)"); filesInput.style.border = "2px solid red"; }

  if (missing.length > 0) {
    return showError("‚ö† Please fill the following required fields:\n\n- " + missing.join("\n- "));
  }

  if (files.length > 10) return showError("‚ö† You can only upload up to 10 PDF files at once.");
  for (let file of files) {
    if (file.type !== "application/pdf") return showError(`‚ö† ${file.name} is not a PDF.`);
    if (file.size > 30 * 1024 * 1024) return showError(`‚ö† ${file.name} exceeds the 30MB limit.`);
  }

  spinner.style.display = "block";
  progressContainer.style.display = "block";
  uploadText.style.display = "block";
  uploadText.textContent = "Uploading... 0%";
  progressBar.style.width = "0%";
  showError("");

  const formData = new FormData();
  formData.append("officerEmail", officerEmail);
  formData.append("evidenceName", evidenceName);
  formData.append("category", category);
  formData.append("indicator", indicator);
  formData.append("subCounty", subCounty);
  for (let file of files) formData.append("files", file, file.name);

  const xhr = new XMLHttpRequest();
  xhr.open("POST", PROXY_URL, true);

  xhr.upload.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = Math.round((event.loaded / event.total) * 100);
      progressBar.style.width = percent + "%";
      uploadText.textContent = `Uploading... ${percent}%`;
    }
  };

  xhr.onload = () => {
    spinner.style.display = "none";
    progressBar.style.width = "100%";
    uploadText.textContent = "Uploading... 100%";

    setTimeout(() => {
      progressContainer.style.display = "none";
      uploadText.style.display = "none";

      if (xhr.status >= 200 && xhr.status < 300) {
        showSuccess(`‚úÖ ${files.length} file(s) submitted successfully. üì© You will receive an email confirmation.`);
        setTimeout(() => {
          resetForm();
          successMsg.style.display = "none";
          successMsg.classList.remove("show");
        }, 4000);

        saveOfficerEmail(officerEmail);
      } else {
        showError("‚ùå Upload failed. Please try again.");
      }
    }, 500);
  };

  xhr.onerror = () => {
    spinner.style.display = "none";
    showError("‚ùå Network error. Please try again.");
  };

  xhr.send(formData);
});
</script>

</body>
</html>
