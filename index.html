<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Nakuru County CCNO PC Evidence Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
    header { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
    header img { height: 50px; }
    .container { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    label { font-weight: bold; margin-top: 10px; display: block; }
    input, select, button { margin-top: 5px; margin-bottom: 15px; width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #0066cc; color: white; border: none; cursor: pointer; }
    button:hover { background: #004c99; }
    .spinner { display: none; font-weight: bold; color: orange; }
    .success { display: none; color: green; font-weight: bold; }
    .error { display: none; color: red; font-weight: bold; }
    .progress-bar-container { width: 100%; background: #ddd; height: 20px; border-radius: 5px; margin: 10px 0; display: none; }
    .progress-bar { height: 100%; width: 0%; background: green; border-radius: 5px; transition: width 0.3s; }
  </style>
</head>
<body>
<header>
  <img src="https://www.nakurucountychiefnursingofficer.site/lovable-uploads/00cc8120-039e-4419-8b2b-e07e69d6fdd8.png" alt="Nakuru County Logo" />
  <h2>Q1 FY 25/26 Performance Contract</h2>
</header>
<div class="container">
  <h2>Nakuru County CCNO PC Evidence Upload</h2>

  <label for="evidenceName">Evidence Name:</label>
  <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods" />

  <label for="category">Evidence Category:</label>
  <select id="category" required>
    <option value="">Select Evidence Category</option>
    <option value="C02 Referral System Improved">C02 Referral System Improved</option>
    <option value="C04 Operationalization of Health Facilities to Better Services">C04 Operationalization of Health Facilities to Better Services</option>
    <option value="C10 Theater Services Improved">C10 Theater Services Improved</option>
    <option value="C11 In-Patient Services Improved">C11 In-Patient Services Improved</option>
    <option value="C14 ANC (Antenatal Care)">C14 ANC (Antenatal Care)</option>
    <option value="C15 POSTNATAL CARE">C15 POSTNATAL CARE</option>
    <option value="C16 MPDSR">C16 MPDSR</option>
    <option value="C17 FAMILY PLANNING">C17 FAMILY PLANNING</option>
    <option value="C18 IMMUNIZATION">C18 IMMUNIZATION</option>
    <option value="C21 HIV SERVICES">C21 HIV SERVICES</option>
    <option value="C23 BURDEN OF CANCER REDUCED">C23 BURDEN OF CANCER REDUCED</option>
    <option value="C27 SUPPORT SUPERVISION">C27 SUPPORT SUPERVISION</option>
  </select>

  <label for="subCounty">Sub County:</label>
  <select id="subCounty" required>
    <option value="">Select Sub County</option>
    <option value="Nakuru West Sub County">Nakuru West Sub County</option>
    <option value="Nakuru East Sub County">Nakuru East Sub County</option>
    <option value="Nakuru North Sub County">Nakuru North Sub County</option>
    <option value="Naivasha Sub County">Naivasha Sub County</option>
    <option value="Rongai Sub County">Rongai Sub County</option>
    <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
    <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
    <option value="Subukia Sub County">Subukia Sub County</option>
    <option value="Molo Sub County">Molo Sub County</option>
    <option value="Njoro Sub County">Njoro Sub County</option>
    <option value="Gilgil Sub County">Gilgil Sub County</option>
  </select>

  <label for="files">Choose PDF file(s) (max 30MB each, up to 5 files):</label>
  <input type="file" id="files" accept="application/pdf" multiple />
  <small>You can select multiple PDF files (maximum 5). Files larger than 30MB will be rejected.</small> 

  <div class="spinner" id="spinner">⏳ Uploading...</div>
  <div class="progress-bar-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="success" id="success">✅ Upload successful!</div>
  <div class="error" id="error"></div>

  <button id="uploadBtn">Upload PDF Evidence</button>
</div>

<script>
document.getElementById("uploadBtn").addEventListener("click", async () => {
  const evidenceName = document.getElementById("evidenceName").value.trim();
  const category = document.getElementById("category").value;
  const subCounty = document.getElementById("subCounty").value;
  const files = document.getElementById("files").files;

  const spinner = document.getElementById("spinner");
  const success = document.getElementById("success");
  const error = document.getElementById("error");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");

  success.style.display = "none";
  error.style.display = "none";

  if (!evidenceName || !category || !subCounty || files.length === 0) {
    error.textContent = "⚠️ Please fill all fields and select at least one PDF file.";
    error.style.display = "block";
    return;
  }

  if (files.length > 5) {
    error.textContent = "⚠️ You can only upload up to 5 files.";
    error.style.display = "block";
    return;
  }

  spinner.style.display = "block";
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";

  try {
    const formData = new FormData();
    formData.append("evidenceName", evidenceName);
    formData.append("category", category);
    formData.append("subCounty", subCounty);

    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      if (file.size > 30 * 1024 * 1024) {
        throw new Error(`File ${file.name} exceeds 30MB limit.`);
      }
      formData.append("files[]", file, file.name);
    }

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "https://script.google.com/macros/s/AKfycbxEWQeq5x4xavrqCSlWNYhC8Q694mJx7x57MiNL6YhdbonD7zNCoCsdSvjxkVhPmtGIeA/exec", true);

    xhr.upload.onprogress = function (event) {
      if (event.lengthComputable) {
        const percent = (event.loaded / event.total) * 100;
        progressBar.style.width = percent + "%";
      }
    };

    xhr.onload = function () {
      spinner.style.display = "none";
      if (xhr.status === 200) {
        const res = JSON.parse(xhr.responseText);
        if (res.success) {
          success.textContent = "✅ Uploaded: " + res.files.map(f => f.name).join(", ");
          success.style.display = "block";

          // ✅ auto-clear form
          document.getElementById("evidenceName").value = "";
          document.getElementById("category").selectedIndex = 0;
          document.getElementById("subCounty").selectedIndex = 0;
          document.getElementById("files").value = "";
          progressBar.style.width = "0%";
          progressContainer.style.display = "none";
        } else {
          error.textContent = "❌ " + res.message;
          error.style.display = "block";
        }
      } else {
        error.textContent = "❌ Upload failed. Server error.";
        error.style.display = "block";
      }
    };

    xhr.send(formData);
  } catch (err) {
    spinner.style.display = "none";
    error.textContent = "❌ " + err.message;
    error.style.display = "block";
  }
});
</script>
</body>
</html>
