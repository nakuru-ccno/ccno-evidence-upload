<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCNO Evidence Upload</title>
<link rel="icon" type="image/x-icon" href="images/favicon.ico">
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; margin: 0; padding: 0; color: #333; }
header { display: flex; align-items: center; gap: 12px; background: #0277bd; padding: 12px 18px; color: #fff; font-weight: 700; font-size: 1.05rem; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
header img { height: 52px; width: 52px; object-fit: contain; background: #fff; border-radius: 50%; padding: 4px; }
.container { max-width: 720px; background: #fff; margin: 36px auto; padding: 28px 32px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); border-top: 6px solid #2e7d32; }
h2 { text-align: center; font-weight: 800; color: #b71c1c; margin: 0 0 20px; }
label { display: block; margin-top: 16px; font-weight: 700; color: #2e7d32; }
input[type="text"], input[type="email"], select, input[type="file"] { width: 100%; padding: 12px 14px; margin-top: 8px; border: 1px solid #cfd8dc; border-radius: 8px; font-size: 1rem; background: #fff; box-sizing: border-box; }
input[type="text"]:focus, input[type="email"]:focus, select:focus, input[type="file"]:focus { outline: none; border-color: #0277bd; box-shadow: 0 0 0 3px rgba(2,119,189,0.15); }
button { margin-top: 22px; width: 100%; padding: 14px 16px; font-size: 1.05rem; background: #b71c1c; color: #fff; border: none; border-radius: 10px; cursor: pointer; font-weight: 800; }
button:hover { background: #d32f2f; }
.spinner { display: none; margin: 16px 0; text-align: center; color: #b71c1c; font-weight: 700; }
.success, .error { display: none; margin: 18px 0; padding: 14px 16px; border-radius: 8px; font-weight: 700; }
.success { background: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; }
.error { background: #ffebee; color: #b71c1c; border: 1px solid #ef9a9a; }
.progress-container { display: none; margin-top: 16px; background: #eee; border-radius: 8px; height: 18px; overflow: hidden; }
.progress-bar { height: 100%; width: 0%; background: #2e7d32; transition: width 0.2s ease; }
#progressText { text-align:right; font-size:0.9rem; color:#2e7d32; display:none; margin-top:4px; }
#g_id_onload, #g_id_signin { display:block; margin-top:12px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<header>
  <img src="images/LOGO.png" alt="Nakuru County Logo" />
  Performance Contract For FY 2025/26
</header>

<div class="container">
  <h2>Nakuru County CCNO PC Evidence Upload</h2>

  <label for="userEmail">Your Email:</label>
  <input type="email" id="userEmail" placeholder="Your email will auto-fill after Google login" />

  <div id="g_id_onload"
       data-client_id="YOUR_GOOGLE_CLIENT_ID"
       data-login_uri=""
       data-auto_prompt="true"
       data-callback="handleCredentialResponse">
  </div>
  <div class="g_id_signin" id="g_id_signin" data-type="standard"></div>

  <label for="evidenceName">Evidence Name:</label>
  <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods" />

  <label for="category">Evidence Category:</label>
  <select id="category"><option value="">Select Evidence Category</option></select>

  <label for="indicator">Indicator:</label>
  <select id="indicator"><option value="">Select Indicator</option></select>

  <label for="subCounty">Sub County:</label>
  <select id="subCounty"><option value="">Select Sub County</option></select>

  <label for="files">Choose PDF file(s):</label>
  <input type="file" id="files" accept="application/pdf" multiple />

  <div class="spinner" id="spinner">‚è≥ Uploading...</div>
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="progressText">0%</div>
  <div class="success" id="success"></div>
  <div class="error" id="error"></div>

  <button id="uploadBtn">Upload Performance Evidence</button>
</div>

<script>
const PROXY_URL = "https://nccnoproxyy.onrender.com/upload-evidence";
const evidenceNameInput = document.getElementById("evidenceName");
const categorySelect = document.getElementById("category");
const indicatorSelect = document.getElementById("indicator");
const subCountySelect = document.getElementById("subCounty");
const filesInput = document.getElementById("files");
const userEmailInput = document.getElementById("userEmail");
const spinner = document.getElementById("spinner");
const successMsg = document.getElementById("success");
const errorMsg = document.getElementById("error");
const uploadBtn = document.getElementById("uploadBtn");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");
const progressText = document.getElementById("progressText");

// --- Populate categories & subCounties ---
const categories = [
  "D3 - Immunization Coverage Increased","D11 - Mental health services improved",
  "D12 - Referral system improved","D14 - Operationalization of health facilities to offer better services",
  "D19 - Theatre Services improved","D20 - In-patient Services Improved","D23 - Antenatal Care Services improved",
  "D24 - Postnatal Care Improved","D25 - Maternal Perinatal Deaths Audited","D26 - Family Planning Uptake improved",
  "D27 - Burden of Cancer Reduced","D29 - Health Services Supervision","D35 - Youth Empowerment Initiatives"
];
categories.forEach(c=>categorySelect.innerHTML+=`<option value="${c}">${c}</option>`);

const subCounties = ["Nakuru West Sub County","Nakuru East Sub County","Nakuru North Sub County","Naivasha Sub County",
"Rongai Sub County","Kuresoi South Sub County","Kuresoi North Sub County","Subukia Sub County","Molo Sub County",
"Njoro Sub County","Gilgil Sub County"];
subCounties.forEach(s=>subCountySelect.innerHTML+=`<option value="${s}">${s}</option>`);

// --- Indicators Map ---
const indicatorsMap = {
  "D3 - Immunization Coverage Increased":["Avail immunization services on daily basis 8am-5pm","Conduct continuous Immunization defaulter tracing","Conduct quarterly CCE assessment in all the immunizing facilities","Conduct monthly integrated outreaches"],
  "D11 - Mental health services improved":["Training of skilled HCWs on mental health and common mental health disorders (mhGAP)","Conduct quarterly debrief/self care sessions for HCWs","Train 3000 CHPs on mental health and psychological first aid","Identification and referral on mental health disorders by CHPs to health facilities"],
  "D12 - Referral system improved":["Strengthen referral system-Revise and disseminate SOPs","Formulate ambulance checklist to ensure consistent availability of emergency response commodities","Procure 2 ACLS ambulances for Naivasha and Molo","Relocate the call Centre to NCRTH and strengthen the call Centre by acquiring a dedicated toll free number"],
  "D14 - Operationalization of health facilities to offer better services":["Operationalize Level 4 new Maternity units in Bondeni, Molo, Gilgil and Githioro L3","Equip 6 new health facilities","Upgrade 3 new level II health facilities to health centres  across the County"],
  "D19 - Theatre Services improved":["Deployment of HRH to operationalize Subukia, Elburgon and Gilgil Theatres","Procurement of Theater equipment for Subukia","Operationalize the theatre at Bondeni SCH","Improved access to safe caesarean sections and anaesthesia care in the 5 targeted facilities, reducing delays and complications during obstetric emergencies. (OSS)"],
  "D20 - In-patient Services Improved":["Hold Hospital Quarterly clinical audit team meetings in level IV / V hospitals","Conduct quarterly Supportive Supervision of all the 16 Level IV & V Hospitals","Formation of IPC committees in all facilities and identification of champions","Re-invigorate audit committies in all hospital with clear terms of reference"],
  "D23 - Antenatal Care Services improved":["Establish/Strengthen cohort group ANC(GANC)","Scale up the number of facilities Enrolling ANC mothers to SMS PROMPTS from 57 to 90","Procure essential and emergency neonatal care equipment"],
  "D24 - Postnatal Care Improved":["Integrate cervical cancer screening in postnatal clinic","Provision of PNC within the first 48 hours in all the delivery units"],
  "D25 - Maternal Perinatal Deaths Audited":["Conduct monthly facility and sub county MPDSR Audit meeting","Track and Implement recommendations of the action points from the MPDSR meetings","Conduct weekly virtual MPDSR meeting at all levels of care"],
  "D26 - Family Planning Uptake improved":["Operationalization of the 4 AYSRH centres .( Ronda HC, Maai Mahiu , Kabazi SCH and Mau Narok HC)","Mentorship / OJT on long acting and reversible contraceptive methods, including Hormonal IUD","Roll out the self-care initiative in reproductive health and DMPA-SC injection","Requisition of family planning commodities"],
  "D27 - Burden of Cancer Reduced":["Undertake cervical cancer Screening","Treatment of cervical cancer lesions","Administration of the HPV 1 vaccine to girls 10 years-14 years.","Conduct Quaterly psychosocial support counselling for cancer survivors"],
  "D29 - Health Services Supervision":["Undertake 3 CHMT supervisions per quarter","Report on implementation of CHMT supervision","SCHMT undertake 33 supervisions","Report on implementation of SCHMT supervision"],
  "D35 - Youth Empowerment Initiatives":["Establishment of youth Friendly Centres in Facilities","Sensitize the youth on YFS,Live saving skills  and Alcohol & Substance Abuse integrate into school health programme","Provision of psychological counselling services in youth friendly centres"]
};

// Populate indicators dynamically
categorySelect.addEventListener("change",()=>{
  const category=categorySelect.value;
  indicatorSelect.innerHTML='<option value="">Select Indicator</option>';
  if(indicatorsMap[category]){
    indicatorsMap[category].forEach(ind=>{
      const opt=document.createElement("option");
      opt.value=ind;
      opt.textContent=ind;
      indicatorSelect.appendChild(opt);
    });
  }
});

// Google callback
function handleCredentialResponse(response){
  const data = JSON.parse(atob(response.credential.split('.')[1]));
  if(data.email) userEmailInput.value = data.email;
}

function showError(msg){ errorMsg.style.display=msg?"block":"none"; errorMsg.textContent=msg; successMsg.style.display="none"; }
function showSuccess(msg){ successMsg.style.display="block"; successMsg.textContent=msg; errorMsg.style.display="none"; setTimeout(()=>{successMsg.style.display="none";},4000); }

uploadBtn.addEventListener("click",()=>{
  const evidenceName=evidenceNameInput.value.trim();
  const category=categorySelect.value;
  const indicator=indicatorSelect.value;
  const subCounty=subCountySelect.value;
  const userEmail=userEmailInput.value.trim();
  const files=filesInput.files;

  if(!evidenceName||!category||!indicator||!subCounty||!files.length||!userEmail) return showError("Please fill all fields and provide your email.");

  spinner.style.display="block"; progressContainer.style.display="block"; progressBar.style.width="0%"; progressText.style.display="block"; progressText.innerText="0%"; showError("");

  const readFilesPromises=[];
  for(let f of files){
    readFilesPromises.push(new Promise((resolve,reject)=>{
      const reader=new FileReader();
      reader.onload=()=>resolve({name:f.name, content:reader.result.split(',')[1]});
      reader.onerror=()=>reject(`Failed to read ${f.name}`);
      reader.readAsDataURL(f);
    }));
  }

  Promise.all(readFilesPromises).then(base64Files=>{
    const payload={evidenceName,category,indicator,subCounty,userEmail,files:base64Files};
    const xhr=new XMLHttpRequest();
    xhr.open("POST",PROXY_URL,true);
    xhr.setRequestHeader("Content-Type","application/json");

    xhr.upload.onprogress=(event)=>{
      if(event.lengthComputable){
        const percent=Math.round((event.loaded/event.total)*100);
        progressBar.style.width=percent+"%";
        progressText.innerText=percent+"%";
      }
    };

    xhr.onload=()=>{
      spinner.style.display="none";
      if(xhr.status>=200 && xhr.status<300) showSuccess(`${evidenceName}_${subCounty} submitted successfully`);
      else showError("Upload failed. Try again.");
    };

    xhr.onerror=()=>{ spinner.style.display="none"; showError("Network error. Try again."); }
    xhr.send(JSON.stringify(payload));
  }).catch(err=>{ spinner.style.display="none"; showError(err); });
});
</script>
</body>
</html>
