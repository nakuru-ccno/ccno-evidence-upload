<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CCNO Evidence Upload</title>
  <link rel="icon" type="image/x-icon" href="images/favicon.ico">
  <style>
    body { display: flex; margin: 0; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f6f9; color: #333; }
    .sidebar {
      width: 250px; background: #e0f2f1;
      padding: 20px; display: flex; flex-direction: column;
      justify-content: space-between; box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    .user-info { color: #1b5e20; font-size: 0.95rem; }
    .user-info div { margin-bottom: 8px; }
    .logout-btn {
      background: #b71c1c; color: #fff; border: none;
      padding: 10px; border-radius: 6px;
      cursor: pointer; font-weight: 700;
    }
    .logout-btn:hover { background: #d32f2f; }
    .main-content { flex: 1; display: flex; flex-direction: column; }
    header {
      display: flex; align-items: center; gap: 12px;
      background: #0277bd; padding: 12px 18px;
      color: #fff; font-weight: 700; font-size: 1.05rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    header img { height: 52px; width: 52px; object-fit: contain; background: #fff; border-radius: 50%; padding: 4px; }
    .container {
      max-width: 720px; background: #fff;
      margin: 36px auto; padding: 28px 32px;
      border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.08);
      border-top: 6px solid #2e7d32;
    }
    h2 { text-align: center; font-weight: 800; color: #b71c1c; margin: 0 0 20px; }
    label { display: block; margin-top: 16px; font-weight: 700; color: #2e7d32; }
    input[type="text"], select, input[type="file"] {
      width: 100%; padding: 12px 14px; margin-top: 8px;
      border: 1px solid #cfd8dc; border-radius: 8px;
      font-size: 1rem; background: #fff; box-sizing: border-box;
    }
    input:focus, select:focus { outline: none; border-color: #0277bd; box-shadow: 0 0 0 3px rgba(2,119,189,0.15); }
    button {
      margin-top: 22px; width: 100%; padding: 14px 16px;
      font-size: 1.05rem; background: #b71c1c; color: #fff;
      border: none; border-radius: 10px; cursor: pointer; font-weight: 800;
    }
    button:hover { background: #d32f2f; }
    .spinner { display: none; margin: 16px 0; text-align: center; color: #b71c1c; font-weight: 700; }
    .success, .error { display: none; margin: 18px 0; padding: 14px 16px; border-radius: 8px; font-weight: 700; }
    .success { background: #e3f2fd; color: #0d47a1; border: 1px solid #90caf9; }
    .error { background: #ffebee; color: #b71c1c; border: 1px solid #ef9a9a; }
    .progress-container { display: none; margin-top: 16px; background: #eee; border-radius: 8px; height: 18px; overflow: hidden; }
    .progress-bar { height: 100%; width: 0%; background: #2e7d32; transition: width 0.2s ease; }
    #progressText { text-align:right; font-size:0.9rem; color:#2e7d32; display:none; margin-top:4px; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="user-info">
      <div id="userName"></div>
      <div id="userEmail"></div>
      <div id="userRole"></div>
      <div id="userStatus"></div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <img src="images/LOGO.png" alt="Nakuru County Logo" />
      Performance Contract For FY 2025/26
    </header>

    <div class="container">
      <h2>Nakuru County CCNO PC Evidence Upload</h2>

      <label for="evidenceName">Evidence Name:</label>
      <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods" />

      <label for="category">Evidence Category:</label>
      <select id="category">
        <option value="">Select Evidence Category</option>
        <option value="D3 - Immunization Coverage Increased">D3 - Immunization Coverage Increased</option>
        <option value="D11 - Mental health services improved">D11 - Mental health services improved</option>
        <option value="D12 - Referral system improved">D12 - Referral system improved</option>
        <option value="D14 - Operationalization of health facilities to offer better services">D14 - Operationalization of health facilities to offer better services</option>
        <option value="D19 - Theatre Services improved">D19 - Theatre Services improved</option>
        <option value="D20 - In-patient Services Improved">D20 - In-patient Services Improved</option>
        <option value="D23 - Antenatal Care Services improved">D23 - Antenatal Care Services improved</option>
        <option value="D24 - Postnatal Care Improved">D24 - Postnatal Care Improved</option>
        <option value="D25 - Maternal Perinatal Deaths Audited">D25 - Maternal Perinatal Deaths Audited</option>
        <option value="D26 - Family Planning Uptake improved">D26 - Family Planning Uptake improved</option>
        <option value="D27 - Burden of Cancer Reduced">D27 - Burden of Cancer Reduced</option>
        <option value="D29 - Health Services Supervision">D29 - Health Services Supervision</option>
        <option value="D35 - Youth Empowerment Initiatives">D35 - Youth Empowerment Initiatives</option>
      </select>

      <label for="indicator">Indicator:</label>
      <select id="indicator">
        <option value="">Select Indicator</option>
      </select>

      <label for="subCounty">Sub County:</label>
      <select id="subCounty">
        <option value="">Select Sub County</option>
        <option value="Nakuru West Sub County">Nakuru West Sub County</option>
        <option value="Nakuru East Sub County">Nakuru East Sub County</option>
        <option value="Nakuru North Sub County">Nakuru North Sub County</option>
        <option value="Naivasha Sub County">Naivasha Sub County</option>
        <option value="Rongai Sub County">Rongai Sub County</option>
        <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
        <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
        <option value="Subukia Sub County">Subukia Sub County</option>
        <option value="Molo Sub County">Molo Sub County</option>
        <option value="Njoro Sub County">Njoro Sub County</option>
        <option value="Gilgil Sub County">Gilgil Sub County</option>
      </select>

      <label for="files">Choose PDF file(s):</label>
      <input type="file" id="files" accept="application/pdf" multiple />

      <div class="spinner" id="spinner">‚è≥ Uploading...</div>
      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="progressText">0%</div>
      <div class="success" id="success"></div>
      <div class="error" id="error"></div>

      <button id="uploadBtn">Upload Performance Evidence</button>
    </div>
  </div>

  <script>
    const PROXY_URL = "https://nccnoproxyy.onrender.com/upload-evidence";
    const indicatorSelect = document.getElementById("indicator");
    const categorySelect = document.getElementById("category");
    const successMsg = document.getElementById("success");
    const errorMsg = document.getElementById("error");
    const spinner = document.getElementById("spinner");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");

    function logout() {
      localStorage.removeItem("ccno_user");
      window.location.href = "login.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      const user = JSON.parse(localStorage.getItem("ccno_user"));
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      document.getElementById("userName").textContent = user.name;
      document.getElementById("userEmail").textContent = user.email;
      document.getElementById("userRole").textContent = "Role: " + user.role;
      document.getElementById("userStatus").textContent = "Status: " + user.status;
    });

    const indicatorsMap = { 
      "D3 - Immunization Coverage Increased": [
        "Avail immunization services on daily basis 8am-5pm",
        "Conduct continuous Immunization defaulter tracing",
        "Conduct quarterly CCE assessment in all the immunizing facilities",
        "Conduct monthly integrated outreaches"
      ],
      "D11 - Mental health services improved": [
        "Training of skilled HCWs on mental health and common mental health disorders (mhGAP)",
        "Conduct quarterly debrief/self care sessions for HCWs",
        "Train 3000 CHPs on mental health and psychological first aid",
        "Identification and referral on mental health disorders by CHPs to health facilities "
      ],
      "D12 - Referral system improved": [
        "Strengthen referral system-Revise and disseminate SOPs",
        "Formulate ambulance checklist",
        "Procure 2 ACLS ambulances",
        "Relocate and strengthen the call Centre"
      ]
      // üîΩ continue filling other categories as in your original code
    };

    categorySelect.addEventListener("change", () => {
      const category = categorySelect.value;
      indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
      if (indicatorsMap[category]) {
        indicatorsMap[category].forEach(ind => {
          const opt = document.createElement("option");
          opt.value = ind;
          opt.textContent = ind;
          indicatorSelect.appendChild(opt);
        });
      }
    });

    document.getElementById("uploadBtn").addEventListener("click", () => {
      const user = JSON.parse(localStorage.getItem("ccno_user"));
      if (!user) return;

      const evidenceName = document.getElementById("evidenceName").value.trim();
      const category = categorySelect.value;
      const indicator = indicatorSelect.value;
      const subCounty = document.getElementById("subCounty").value;
      const files = document.getElementById("files").files;

      if (!evidenceName || !category || !indicator || !subCounty || !files.length) {
        errorMsg.style.display = "block";
        errorMsg.textContent = "Please fill all fields and select at least one PDF file.";
        return;
      }

      spinner.style.display = "block";
      progressContainer.style.display = "block";
      progressBar.style.width = "0%";
      progressText.style.display = "block";
      progressText.innerText = "0%";
      errorMsg.style.display = "none";
      successMsg.style.display = "none";

      const formData = new FormData();
      formData.append("uploaderEmail", user.email);
      formData.append("uploaderName", user.name);
      formData.append("role", user.role);
      formData.append("evidenceName", evidenceName);
      formData.append("category", category);
      formData.append("indicator", indicator);
      formData.append("subCounty", subCounty);
      for (let file of files) formData.append("files", file, file.name);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", PROXY_URL, true);

      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const percent = Math.round((event.loaded / event.total) * 100);
          progressBar.style.width = percent + "%";
          progressText.innerText = percent + "%";
        }
      };

      xhr.onload = () => {
        spinner.style.display = "none";
        if (xhr.status >= 200 && xhr.status < 300) {
          successMsg.style.display = "block";
          successMsg.textContent = `${user.name}_${evidenceName}_${subCounty}.pdf submitted successfully`;
          setTimeout(() => { successMsg.style.display = "none"; }, 4000);
          document.getElementById("evidenceName").value = "";
          categorySelect.value = "";
          indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
          document.getElementById("subCounty").value = "";
          document.getElementById("files").value = "";
          progressBar.style.width = "0%";
          progressContainer.style.display = "none";
          progressText.style.display = "none";
        } else {
          errorMsg.style.display = "block";
          errorMsg.textContent = "Upload failed. Try again.";
        }
      };

      xhr.onerror = () => {
        spinner.style.display = "none";
        errorMsg.style.display = "block";
        errorMsg.textContent = "Network error. Try again.";
      };

      xhr.send(formData);
    });
  </script>
</body>
</html>
