<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCNO Evidence Upload</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9f9f9;
    margin: 0; padding: 0;
    color: #000;
  }
  header {
    display: flex;
    align-items: center;
    background: #0277bd;
    padding: 10px 20px;
    color: white;
    font-weight: 600;
    font-size: 1.2em;
  }
  header img { height: 50px; margin-right: 15px; }
  .container {
    max-width: 650px; background: white; margin: 40px auto;
    padding: 30px; border-radius: 8px; border: 2px solid #2e7d32;
  }
  h2 { text-align: center; font-weight: bold; color: #b71c1c; margin-top: 0; margin-bottom: 20px; }
  label { display: block; margin-top: 15px; font-weight: 600; color: #2e7d32; }
  input[type="text"], select, input[type="file"] {
    width: 100%; padding: 10px; margin-top: 6px;
    border: 1px solid #ccc; border-radius: 4px; font-size: 1em;
  }
  input[type="file"] { padding: 5px; }
  small { display: block; font-size: 0.85em; color: #666; margin-top: 4px; }
  button {
    margin-top: 25px; width: 100%; padding: 14px;
    font-size: 1.1em; background-color: #b71c1c; color: white;
    border: none; border-radius: 5px; cursor: pointer;
    font-weight: 700; transition: background-color 0.25s ease;
  }
  button:hover { background-color: #d32f2f; }
  .spinner { display: none; margin: 20px 0; text-align: center; color: #b71c1c; font-weight: 600; }
  .progress-bar-container { display: none; width: 100%; background: #eee; border-radius: 4px; margin-top: 15px; }
  .progress-bar { width: 0%; height: 20px; background: #2e7d32; border-radius: 4px; transition: width 0.3s ease; text-align: center; color: white; font-weight: 600; line-height: 20px; }
  .success { display: none; margin: 20px 0; padding: 15px; background: #bbdefb; color: #0d47a1; border-radius: 4px; font-weight: 600; }
  .error { display: none; margin: 20px 0; padding: 15px; background: #ffcdd2; color: #b71c1c; border-radius: 4px; font-weight: 600; }
</style>
</head>
<body>
<header>
  <img src="https://www.nakurucountychiefnursingofficer.site/lovable-uploads/00cc8120-039e-4419-8b2b-e07e69d6fdd8.png" alt="Nakuru County Logo" />
  Q1 FY 25/26 Performance Contract
</header>
<div class="container">
  <h2>Nakuru County CCNO PC Evidence Upload</h2>

  <label for="evidenceName">Evidence Name:</label>
  <input type="text" id="evidenceName" name="evidenceName" placeholder="e.g., CME on Family Planning Methods" />
  <small>Give a short descriptive name for this evidence.</small>

  <label for="category">Evidence Category:</label>
  <select id="category" name="category" required>
    <option value="">Select Evidence Category</option>
    <option value="C02 Referral System Improved">C02 Referral System Improved</option>
    <option value="C04 Operationalization of Health Facilities to Better Services">C04 Operationalization of Health Facilities to Better Services</option>
    <option value="C10 Theater Services Improved">C10 Theater Services Improved</option>
    <option value="C11 In-Patient Services Improved">C11 In-Patient Services Improved</option>
    <option value="C14 ANC (Antenatal Care)">C14 ANC (Antenatal Care)</option>
    <option value="C15 POSTNATAL CARE">C15 POSTNATAL CARE</option>
    <option value="C16 MPDSR">C16 MPDSR</option>
    <option value="C17 FAMILY PLANNING">C17 FAMILY PLANNING</option>
    <option value="C18 IMMUNIZATION">C18 IMMUNIZATION</option>
    <option value="C21 HIV SERVICES">C21 HIV SERVICES</option>
    <option value="C23 BURDEN OF CANCER REDUCED">C23 BURDEN OF CANCER REDUCED</option>
    <option value="C27 SUPPORT SUPERVISION">C27 SUPPORT SUPERVISION</option>
  </select>

  <label for="subCounty">Sub County:</label>
  <select id="subCounty" name="subCounty" required>
    <option value="">Select Sub County</option>
    <option value="Nakuru West Sub County">Nakuru West Sub County</option>
    <option value="Nakuru East Sub County">Nakuru East Sub County</option>
    <option value="Nakuru North Sub County">Nakuru North Sub County</option>
    <option value="Naivasha Sub County">Naivasha Sub County</option>
    <option value="Rongai Sub County">Rongai Sub County</option>
    <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
    <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
    <option value="Subukia Sub County">Subukia Sub County</option>
    <option value="Molo Sub County">Molo Sub County</option>
    <option value="Njoro Sub County">Njoro Sub County</option>
    <option value="Gilgil Sub County">Gilgil Sub County</option>
  </select>

  <label for="files">Choose PDF file(s) (max 20MB each, up to 5 files):</label>
  <input type="file" id="files" name="files" accept="application/pdf" multiple />
  <small>You can select multiple PDF files (maximum 5). Files larger than 20MB will be rejected.</small>

  <div class="spinner" id="spinner">⏳ Uploading...</div>
  <div class="progress-bar-container" id="progressContainer">
    <div class="progress-bar" id="progressBar">0%</div>
  </div>
  <div class="success" id="success">✅ Upload successful!</div>
  <div class="error" id="error"></div>

  <button id="uploadBtn">Upload PDF Evidence</button>
</div>

<script>
const PROXY_URL = 'https://nccnoproxyy.onrender.com/upload-evidence';

const evidenceNameInput = document.getElementById('evidenceName');
const categorySelect = document.getElementById('category');
const subCountySelect = document.getElementById('subCounty');
const filesInput = document.getElementById('files');
const spinner = document.getElementById('spinner');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const successMsg = document.getElementById('success');
const errorMsg = document.getElementById('error');
const uploadBtn = document.getElementById('uploadBtn');

function showError(msg) {
  errorMsg.textContent = msg;
  errorMsg.style.display = 'block';
  successMsg.style.display = 'none';
  spinner.style.display = 'none';
  progressContainer.style.display = 'none';
  uploadBtn.disabled = false;
}

function showSuccess(fileNames) {
  successMsg.style.display = 'block';
  successMsg.textContent = `✅ Upload successful! Files: ${fileNames.join(', ')}`;
  errorMsg.style.display = 'none';
  spinner.style.display = 'none';
  progressContainer.style.display = 'none';
  uploadBtn.disabled = false;

  setTimeout(() => { successMsg.style.display = 'none'; }, 4000); // auto-clear after 4s
}

async function upload() {
  const evidenceName = evidenceNameInput.value.trim();
  const category = categorySelect.value;
  const subCounty = subCountySelect.value;
  const files = filesInput.files;

  if (!evidenceName || !category || !subCounty) { showError('Please fill in all required fields.'); return; }
  if (files.length === 0) { showError('Please select at least one PDF file.'); return; }
  if (files.length > 5) { showError('Maximum 5 files allowed.'); return; }

  for (let f of files) {
    if (f.size > 20 * 1024 * 1024) { showError(`File ${f.name} exceeds 20MB.`); return; }
    if (f.type !== 'application/pdf') { showError(`File ${f.name} is not a PDF.`); return; }
  }

  spinner.style.display = 'block';
  uploadBtn.disabled = true;
  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';
  progressBar.textContent = '0%';
  successMsg.style.display = 'none';
  errorMsg.style.display = 'none';

  try {
    const formData = new FormData();
    formData.append("evidenceName", evidenceName);
    formData.append("category", category);
    formData.append("subCounty", subCounty);

    for (let i = 0; i < files.length; i++) {
      formData.append("files", files[i], files[i].name);
    }

    const xhr = new XMLHttpRequest();
    xhr.open("POST", PROXY_URL, true);

    xhr.upload.onprogress = (event) => {
      if (event.lengthComputable) {
        const percent = Math.round((event.loaded / event.total) * 100);
        progressBar.style.width = percent + "%";
        progressBar.textContent = percent + "%"; // show numeric percentage
      }
    };

    xhr.onload = () => {
      // Fire-and-forget: mark success immediately
      const uploadedFileNames = Array.from(files).map(f => `${evidenceName} – ${subCounty}.pdf`);
      showSuccess(uploadedFileNames);

      // Reset fields
      evidenceNameInput.value = '';
      categorySelect.value = '';
      subCountySelect.value = '';
      filesInput.value = '';
    };

    xhr.onerror = () => { showError('Network error. Try again.'); };
    xhr.send(formData);

  } catch (err) { showError('Upload failed: ' + err.message); }
}

uploadBtn.addEventListener('click', upload);
</script>
