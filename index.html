<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CCNO Evidence Upload</title>
<link rel="icon" type="image/x-icon" href="images/favicon.ico">

<style>
/* General */
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f4f6f9;
  margin: 0;
  padding: 0;
  color: #333;
}

/* Header / top section */
header {
  display: flex;
  align-items: center;
  gap: 12px;
  background: #0277bd;
  padding: 16px 18px;
  color: #fff;
  font-weight: 700;
  font-size: 1.1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}
header img {
  height: 52px;
  width: 52px;
  object-fit: contain;
  background: #fff;
  border-radius: 50%;
  padding: 4px;
}

/* Container */
.container {
  max-width: 720px;
  background: #fff;
  margin: 24px auto;
  padding: 28px 32px;
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
  border-top: 6px solid #2e7d32;
}

/* Form headings */
h2 {
  text-align: center;
  font-weight: 800;
  color: #b71c1c;
  margin-bottom: 20px;
}

/* Labels and inputs */
label {
  display: block;
  margin-top: 16px;
  font-weight: 700;
  color: #2e7d32;
}
input[type="text"],
input[type="email"],
select,
input[type="file"] {
  width: 100%;
  padding: 12px 14px;
  margin-top: 8px;
  border: 1px solid #cfd8dc;
  border-radius: 8px;
  font-size: 1rem;
  background: #fff;
  box-sizing: border-box;
}
input[type="text"]:focus,
input[type="email"]:focus,
select:focus,
input[type="file"]:focus {
  outline: none;
  border-color: #0277bd;
  box-shadow: 0 0 0 3px rgba(2,119,189,0.15);
}

/* Info message under email input */
.email-note {
  font-size: 0.9rem;
  color: #607d8b;
  margin-top: 6px;
}

/* Button */
button {
  margin-top: 22px;
  width: 100%;
  padding: 14px 16px;
  font-size: 1.05rem;
  background: #b71c1c;
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  font-weight: 800;
}
button:hover {
  background: #d32f2f;
}

/* Spinner and messages */
.spinner,
.success,
.error {
  display: none;
  margin: 16px 0;
  padding: 12px 14px;
  border-radius: 8px;
  font-weight: 700;
  text-align: center;
}
.spinner {
  color: #b71c1c;
}
.success {
  background: #e3f2fd;
  color: #0d47a1;
  border: 1px solid #90caf9;
}
.error {
  background: #ffebee;
  color: #b71c1c;
  border: 1px solid #ef9a9a;
}

/* Progress bar */
.progress-container {
  display: none;
  margin-top: 16px;
  background: #eee;
  border-radius: 8px;
  height: 18px;
  overflow: hidden;
}
.progress-bar {
  height: 100%;
  width: 0%;
  background: #2e7d32;
  transition: width 0.2s ease;
}

/* Mobile adjustments */
@media (max-width: 480px) {
  .container {
    margin: 12px;
    padding: 20px;
  }
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  header img {
    margin-bottom: 8px;
  }
}
</style>
</head>
<body>

<header>
  <img src="images/LOGO.png" alt="Nakuru County Logo" />
  Q1 FY 25/26 Performance Contract
</header>

<div class="container">
  <h2>Nakuru County CCNO PC Evidence Upload</h2>

  <!-- Officer Email -->
  <label for="officerEmail">Officer Email:</label>
  <input type="email" id="officerEmail" placeholder="Enter officer's email" required />
  <div class="email-note">üì© You will receive an email confirmation once your files are saved.</div>

  <!-- Evidence Name -->
  <label for="evidenceName">Evidence Name:</label>
  <input type="text" id="evidenceName" placeholder="e.g., CME on Family Planning Methods" />

  <!-- Category -->
  <label for="category">Evidence Category:</label>
  <select id="category">
    <option value="">Select Evidence Category</option>
  </select>

  <!-- Indicator -->
  <label for="indicator">Indicator:</label>
  <select id="indicator">
    <option value="">Select Indicator</option>
  </select>

  <!-- Sub County -->
  <label for="subCounty">Sub County:</label>
<select id="subCounty">
  <option value="">Select Sub County</option>
  <option value="Nakuru West Sub County">Nakuru West Sub County</option>
  <option value="Nakuru East Sub County">Nakuru East Sub County</option>
  <option value="Nakuru North Sub County">Nakuru North Sub County</option>
  <option value="Naivasha Sub County">Naivasha Sub County</option>
  <option value="Rongai Sub County">Rongai Sub County</option>
  <option value="Kuresoi South Sub County">Kuresoi South Sub County</option>
  <option value="Kuresoi North Sub County">Kuresoi North Sub County</option>
  <option value="Subukia Sub County">Subukia Sub County</option>
  <option value="Molo Sub County">Molo Sub County</option>
  <option value="Njoro Sub County">Njoro Sub County</option>
  <option value="Gilgil Sub County">Gilgil Sub County</option>
</select>

  <!-- Files -->
  <label for="files">Choose PDF file(s):</label>
  <input type="file" id="files" accept="application/pdf" multiple />

  <!-- Spinner, progress, messages -->
  <div class="spinner" id="spinner">‚è≥ Uploading...</div>
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div class="success" id="success"></div>
  <div class="error" id="error"></div>

  <button id="uploadBtn">Upload Evidence</button>
</div>

<script>
const PROXY_URL = "https://nccnoproxyy.onrender.com/upload-evidence";

const officerEmailInput = document.getElementById("officerEmail");
const evidenceNameInput = document.getElementById("evidenceName");
const categorySelect = document.getElementById("category");
const indicatorSelect = document.getElementById("indicator");
const subCountySelect = document.getElementById("subCounty");
const filesInput = document.getElementById("files");
const spinner = document.getElementById("spinner");
const successMsg = document.getElementById("success");
const errorMsg = document.getElementById("error");
const uploadBtn = document.getElementById("uploadBtn");
const progressContainer = document.getElementById("progressContainer");
const progressBar = document.getElementById("progressBar");

// Load categories + indicators from JSON
fetch("indicators.json")
  .then(res => res.json())
  .then(data => {
    Object.keys(data).forEach(category => {
      const opt = document.createElement("option");
      opt.value = category;
      opt.textContent = category;
      categorySelect.appendChild(opt);
    });

    categorySelect.addEventListener("change", () => {
      const selected = categorySelect.value;
      indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
      if (data[selected]) {
        data[selected].forEach(ind => {
          const opt = document.createElement("option");
          opt.value = ind;
          opt.textContent = ind;
          indicatorSelect.appendChild(opt);
        });
      }
    });
  });

// Helper functions
function showError(msg) {
  errorMsg.style.display = msg ? "block" : "none";
  errorMsg.textContent = msg;
  successMsg.style.display = "none";
}

function showSuccess(msg) {
  successMsg.style.display = "block";
  successMsg.textContent = msg;
  errorMsg.style.display = "none";
  setTimeout(() => (successMsg.style.display = "none"), 4000);
}

function resetForm() {
  officerEmailInput.value = "";
  evidenceNameInput.value = "";
  categorySelect.value = "";
  indicatorSelect.innerHTML = '<option value="">Select Indicator</option>';
  subCountySelect.value = "";
  filesInput.value = "";
  progressBar.style.width = "0%";
  progressContainer.style.display = "none";
}

// Upload
uploadBtn.addEventListener("click", () => {
  const officerEmail = officerEmailInput.value.trim();
  const evidenceName = evidenceNameInput.value.trim();
  const category = categorySelect.value;
  const indicator = indicatorSelect.value;
  const subCounty = subCountySelect.value;
  const files = filesInput.files;

  if (!officerEmail || !evidenceName || !category || !indicator || !subCounty || !files.length) {
    return showError("‚ö†Ô∏è Please fill all fields and select at least one PDF file.");
  }

  // Validate files
  if (files.length > 10) {
    return showError("‚ö†Ô∏è You can only upload up to 10 PDF files at once.");
  }

  for (let file of files) {
    if (file.type !== "application/pdf") {
      return showError(`‚ö†Ô∏è ${file.name} is not a PDF.`);
    }
    if (file.size > 30 * 1024 * 1024) {
      return showError(`‚ö†Ô∏è ${file.name} exceeds the 30MB limit.`);
    }
  }

  spinner.style.display = "block";
  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  showError("");

  const formData = new FormData();
  formData.append("officerEmail", officerEmail);
  formData.append("evidenceName", evidenceName);
  formData.append("category", category);
  formData.append("indicator", indicator);
  formData.append("subCounty", subCounty);
  for (let file of files) {
    formData.append("files", file, file.name);
  }

  const xhr = new XMLHttpRequest();
  xhr.open("POST", PROXY_URL, true);

  xhr.upload.onprogress = (event) => {
    if (event.lengthComputable) {
      const percent = (event.loaded / event.total) * 100;
      progressBar.style.width = percent + "%";
    }
  };

  xhr.onload = () => {
    spinner.style.display = "none";
    if (xhr.status >= 200 && xhr.status < 300) {
      showSuccess(`‚úÖ ${files.length} file(s) submitted successfully. üì© You will receive an email confirmation.`);
      resetForm();
    } else {
      showError("‚ùå Upload failed. Please try again.");
    }
  };

  xhr.onerror = () => {
    spinner.style.display = "none";
    showError("‚ùå Network error. Please try again.");
  };

  xhr.send(formData);
});
</script>

</body>
</html>
